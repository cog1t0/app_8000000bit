<div class="max-w-3xl mx-auto p-6 bg-white rounded-lg shadow-lg mt-10">
  <h1 class="text-3xl font-bold text-center mb-8">
    Hello from 8000000bit.app ğŸ‘‹
  </h1>
  
  <div class="mb-6 p-4 bg-gray-50 rounded-md">
    <h2 class="text-xl font-semibold mb-3">ã‚ãªãŸã®æƒ…å ±</h2>
    <div id="first-visit" class="mb-2">åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ—¥: <span class="font-medium">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    <div id="location-info" class="mb-2">ä½ç½®æƒ…å ±: <span class="font-medium">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    <div id="address-info" class="mb-2">è¨ªå•å ´æ‰€: <span class="font-medium">æœªå–å¾—</span></div>
  </div>
  
  <div id="location-container" class="text-center">
    <div id="location-prompt" class="mb-4 hidden">
      <p class="text-gray-700 mb-2">åˆå›è¨ªå•ã®è¨˜å¿µã¨ã—ã¦ã€ã‚ãªãŸãŒæœ€åˆã«ã“ã®ã‚µã‚¤ãƒˆã‚’è¨ªã‚ŒãŸå ´æ‰€ã‚’è¨˜éŒ²ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
      <p class="text-sm text-gray-500 mb-3">ã“ã®æƒ…å ±ã¯ã‚ãªãŸã®ãƒ‡ãƒã‚¤ã‚¹ã«ã®ã¿ä¿å­˜ã•ã‚Œã€ä¸€åº¦ã ã‘è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</p>
      <button id="get-location" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
        </svg>
        è¨˜å¿µã«ç¾åœ¨åœ°ã‚’è¨˜éŒ²ã™ã‚‹
      </button>
    </div>
    <p id="location-status" class="text-sm text-gray-600"></p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ—¥ã®ç®¡ç†
    const firstVisitElement = document.getElementById('first-visit');
    const firstVisitDate = localStorage.getItem('8000000bit_first_visit');
    
    if (!firstVisitDate) {
      // åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆã¯ç¾åœ¨ã®æ—¥æ™‚ã‚’ä¿å­˜
      const now = new Date();
      const formattedDate = now.toLocaleString('ja-JP');
      localStorage.setItem('8000000bit_first_visit', formattedDate);
      firstVisitElement.querySelector('span').textContent = formattedDate + ' (ä»Šå›ãŒåˆã‚ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã™)';
    } else {
      // éå»ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã“ã¨ãŒã‚ã‚‹å ´åˆ
      firstVisitElement.querySelector('span').textContent = firstVisitDate;
    }
    
    // ä½ç½®æƒ…å ±ã¨ä½æ‰€ã®å–å¾—ã¨è¡¨ç¤º
    const locationElement = document.getElementById('location-info');
    const addressElement = document.getElementById('address-info');
    const locationButton = document.getElementById('get-location');
    const locationStatus = document.getElementById('location-status');
    const locationPrompt = document.getElementById('location-prompt');
    
    // ä¿å­˜æ¸ˆã¿ã®ä½ç½®æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
    const savedLocation = localStorage.getItem('8000000bit_location');
    const savedAddress = localStorage.getItem('8000000bit_address');
    
    if (savedLocation) {
      // ã™ã§ã«ä½ç½®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      locationElement.querySelector('span').textContent = savedLocation;
      locationStatus.textContent = 'ğŸ– ã‚ãªãŸãŒåˆã‚ã¦ã“ã®ã‚µã‚¤ãƒˆã‚’è¨ªã‚ŒãŸå ´æ‰€ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™';
      
      // ä½æ‰€ã‚‚è¡¨ç¤º
      if (savedAddress) {
        addressElement.querySelector('span').textContent = savedAddress;
      } else {
        // ä½ç½®æƒ…å ±ã¯ã‚ã‚‹ãŒä½æ‰€ãŒãªã„å ´åˆï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ç§»è¡Œï¼‰
        addressElement.querySelector('span').textContent = 'å¤‰æ›ä¸­...';
        const coords = savedLocation.match(/ç·¯åº¦: ([\d.]+), çµŒåº¦: ([\d.]+)/);
        if (coords && coords.length === 3) {
          const latitude = coords[1];
          const longitude = coords[2];
          
          // éåŒæœŸã§ä½æ‰€ã‚’å–å¾—
          getAddressFromCoordinates(latitude, longitude).then(address => {
            localStorage.setItem('8000000bit_address', address);
            addressElement.querySelector('span').textContent = address;
          });
        }
      }
    } else {
      // ä½ç½®æƒ…å ±ãŒã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆ
      locationElement.querySelector('span').textContent = 'æœªè¨˜éŒ²';
      addressElement.querySelector('span').textContent = 'æœªè¨˜éŒ²';
      locationPrompt.classList.remove('hidden'); // ä½ç½®æƒ…å ±å–å¾—ã®æ¡ˆå†…ã‚’è¡¨ç¤º
    }
    
    // ä½æ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function getAddressFromCoordinates(latitude, longitude) {
      try {
        // OpenStreetMapã®Nominatim APIã‚’ä½¿ç”¨ï¼ˆåˆ©ç”¨è¦ç´„ã«æ³¨æ„ï¼‰
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1&accept-language=ja`);
        const data = await response.json();
        
        // å¿œç­”ã‹ã‚‰ä½æ‰€ã‚’æŠ½å‡º
        if (data && data.display_name) {
          return data.display_name;
        } else {
          return 'ä½æ‰€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        }
      } catch (error) {
        console.error('ä½æ‰€ã®å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
        return 'ä½æ‰€ã®å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    }
    
    // ä½ç½®æƒ…å ±å–å¾—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    locationButton.addEventListener('click', function() {
      if (navigator.geolocation) {
        locationElement.querySelector('span').textContent = 'å–å¾—ä¸­...';
        addressElement.querySelector('span').textContent = 'å–å¾—ä¸­...';
        locationButton.disabled = true;
        locationButton.classList.add('opacity-50');
        locationStatus.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...';
        
        navigator.geolocation.getCurrentPosition(
          // æˆåŠŸæ™‚
          async function(position) {
            const latitude = position.coords.latitude.toFixed(6);
            const longitude = position.coords.longitude.toFixed(6);
            const locationText = `ç·¯åº¦: ${latitude}, çµŒåº¦: ${longitude}`;
            
            // ä½ç½®æƒ…å ±ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆä¸€åº¦ã ã‘ï¼‰
            localStorage.setItem('8000000bit_location', locationText);
            locationElement.querySelector('span').textContent = locationText;
            
            // ä½æ‰€ã‚’å–å¾—ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            addressElement.querySelector('span').textContent = 'å ´æ‰€ã‚’ç‰¹å®šã—ã¦ã„ã¾ã™...';
            locationStatus.textContent = 'ç¾åœ¨åœ°ã®ä½æ‰€æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...';
            
            // ä½æ‰€ã‚’å–å¾—ã—ã¦è¡¨ç¤º
            const address = await getAddressFromCoordinates(latitude, longitude);
            localStorage.setItem('8000000bit_address', address);
            addressElement.querySelector('span').textContent = address;
            
            // å–å¾—ãŒå®Œäº†ã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¦æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            locationPrompt.classList.add('hidden');
            locationStatus.textContent = 'ğŸ‰ è¨˜å¿µã«ç¾åœ¨åœ°ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ã“ã®è¨˜éŒ²ã¯ä»Šå¾Œã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚‚è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™';
          },
          // å¤±æ•—æ™‚
          function(error) {
            let errorMessage;
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'ç¾åœ¨åœ°ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸ';
                break;
              case error.TIMEOUT:
                errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¾ã—ãŸ';
                break;
              default:
                errorMessage = 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
            locationElement.querySelector('span').textContent = errorMessage;
            addressElement.querySelector('span').textContent = 'å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«æˆ»ã—ã¦å†è©¦è¡Œå¯èƒ½ã«ã™ã‚‹
            locationButton.disabled = false;
            locationButton.classList.remove('opacity-50');
            locationStatus.textContent = 'å†åº¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã¾ãŸã¯ã€ã“ã®ã¾ã¾è¨˜éŒ²ãªã—ã§ç¶šã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚';
          }
        );
      } else {
        locationElement.querySelector('span').textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        addressElement.querySelector('span').textContent = 'å–å¾—ã§ãã¾ã›ã‚“';
        locationStatus.textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ããªã„ãŸã‚ã€è¨˜éŒ²ã¯æ®‹ã›ã¾ã›ã‚“ã€‚';
      }
    });
  });
</script>